---
- name: Create Windows Failover Cluster
  hosts: sql_servers
  gather_facts: no
  serial: 1

  tasks:
    - name: Test cluster configuration (run on first node only)
      win_shell: |
        Test-Cluster -Node sql01.{{ domain_name }},sql02.{{ domain_name }},sql03.{{ domain_name }} -Include "Inventory","Network","System Configuration"
      register: cluster_test
      when: inventory_hostname == 'sql01'
      ignore_errors: yes

    - name: Display cluster validation results
      debug:
        var: cluster_test.stdout_lines
      when: inventory_hostname == 'sql01' and cluster_test is defined

- name: Create the cluster (run on first node)
  hosts: sql01
  gather_facts: no

  tasks:
    - name: Create Multi-Subnet Windows Failover Cluster
      win_shell: |
        # Multi-subnet cluster requires multiple static IP addresses (one per subnet)
        New-Cluster -Name {{ cluster_name }} `
          -Node sql01.{{ domain_name }},sql02.{{ domain_name }},sql03.{{ domain_name }} `
          -StaticAddress {{ cluster_ips | join(',') }} `
          -NoStorage
      register: cluster_create
      ignore_errors: yes

    - name: Display cluster creation result
      debug:
        var: cluster_create

    - name: Set cluster quorum to Node Majority
      win_shell: |
        Set-ClusterQuorum -NodeMajority
      when: cluster_create is succeeded

    - name: Configure multi-subnet cluster network settings
      win_shell: |
        # Configure all cluster networks for multi-subnet support
        Get-ClusterNetwork | ForEach-Object {
            Set-ClusterNetwork -InputObject $_ -Role ClusterAndClient
        }

        # Enable multi-subnet failover for the cluster
        # Set SameSubnetDelay and CrossSubnetDelay for faster failover
        Get-Cluster | Set-ClusterParameter -Name SameSubnetDelay -Value 1000
        Get-Cluster | Set-ClusterParameter -Name CrossSubnetDelay -Value 1000
        Get-Cluster | Set-ClusterParameter -Name SameSubnetThreshold -Value 5
        Get-Cluster | Set-ClusterParameter -Name CrossSubnetThreshold -Value 5

    - name: Disable cluster shared volumes (not needed for AG)
      win_shell: |
        Disable-ClusterStorageSpacesDirect -Confirm:$false
      ignore_errors: yes

    - name: Get cluster information
      win_shell: |
        Get-Cluster | Format-List *
      register: cluster_info

    - name: Display multi-subnet cluster information
      debug:
        msg: |
          Multi-Subnet Windows Failover Cluster Created!
          Cluster Name: {{ cluster_name }}
          Cluster IPs (Multi-Subnet):
            - {{ cluster_ips[0] }} (SQL Subnet 1)
            - {{ cluster_ips[1] }} (SQL Subnet 2)
            - {{ cluster_ips[2] }} (SQL Subnet 3)
          Nodes:
            - sql01.{{ domain_name }} (192.168.101.11)
            - sql02.{{ domain_name }} (192.168.102.12)
            - sql03.{{ domain_name }} (192.168.103.13)
          Quorum: Node Majority
          Configuration: Multi-Subnet (mimics AWS Multi-AZ / Azure Availability Zones)

    - name: Get cluster nodes
      win_shell: |
        Get-ClusterNode | Format-Table Name, State, NodeWeight -AutoSize
      register: cluster_nodes

    - name: Display cluster nodes
      debug:
        var: cluster_nodes.stdout_lines
